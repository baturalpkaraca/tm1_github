FEEDSTRINGS;
SKIPCHECK;

[] = IF( ELPAR( 'Version', !Version, 1 ) @= 'Aktif', CONTINUE, STET );

# Budget 2025 Arşive çekilince bu satırı sil aşağıdakini aç.
[] = N: IF(!Version @<> 'Budget 2025' & DB('MM_V_P', !Masraf_Kar_Merkezleri, !Version, !Period, 'Açık / Kapalı' ) @= 'KAPALI', STET, CONTINUE );
# [] = N: IF(DB('MM_V_P', !Masraf_Kar_Merkezleri, !Version, !Period, 'Açık / Kapalı' ) @= 'KAPALI', STET, CONTINUE );

[{'Kapanış Tutarı', 'Oran %', 'Kira Ciro %', 'Artış Tutarı (Sabit için)'}] = C: 0;

# Mağaza bütçe senesinde açıldıysa, değişim ayı boş olmalı, hiç artmamalı.
['Değişim ayı'] =
    S: IF (SUBST(DB('MM_V', !Masraf_Kar_Merkezleri, !Version, 'Açılış Tarihi (yyyy-mm-dd)'), 1, 4)
           @= SUBST( !Period, 1, 4 ), '', CONTINUE);
           
# Artış Tutarı 0 olmalı.
['Artış Tutarı (Sabit için)'] =
	N: IF (SUBST(DB('MM_V', !Masraf_Kar_Merkezleri, !Version, 'Açılış Tarihi (yyyy-mm-dd)'), 1, 4)
           @= SUBST( !Period, 1, 4 ), 0, CONTINUE);

['Aylık - Yıllık Seçim'] =
	S: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Kapanış Tutarı') <> 0 & 
            DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Kira Ciro %') <> 0, CONTINUE, '');   

['Oran Seçimi'] =
	S: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Sabit/Oran') @= 'Sabit', '', CONTINUE);          

['Oran %'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Sabit/Oran') @= 'Sabit', 0, CONTINUE);


['Oran %'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Oran Seçimi') @= 'TÜFE',
            DB( 'V_P', !Version, ATTRS( 'Period', DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Değişim Ayı'), 'PrevMonth' ), 'Enflasyon Oranı % - TÜFE'  ),
			CONTINUE);

['Oran %'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Oran Seçimi') @= 'TÜFE - 12 Aylık',
            DB( 'V_P', !Version, ATTRS( 'Period', DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Değişim Ayı'), 'PrevMonth' ), 'Enflasyon Oranı % - TÜFE - 12 Aylık'  ),
			CONTINUE);

['Oran %'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Oran Seçimi') @= 'ÜFE',
            DB( 'V_P', !Version, ATTRS( 'Period', DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Değişim Ayı'), 'PrevMonth' ), 'Enflasyon Oranı % - ÜFE'  ),
			CONTINUE);

['Oran %'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Oran Seçimi') @= 'ÜFE TÜFE ort.',
            DB( 'V_P', !Version, ATTRS( 'Period', DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Değişim Ayı'), 'PrevMonth' ), 'Enflasyon Oranı % - ÜFE TÜFE ort.'  ),
			CONTINUE);

['Artış Tutarı (Sabit için)'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Sabit/Oran') @= 'Oran', 0, CONTINUE);


['Kira Türü'] = S: IF(DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Kapanış Tutarı') = 0 &
                     DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, !Period, 'Kira Ciro %') <> 0, 'CİRO', '');

# Değişim ayı boş bırakılmış ise.
['Hesaplanan Kira'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Değişim ayı') @= '',
			DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Kapanış Tutarı'),
			CONTINUE);                           

# Değişim ayından önceki aylar için.
['Hesaplanan Kira'] =
	N: IF ( ATTRN('Period', !Period, 'Index') <
			ATTRN('Period', DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Değişim ayı'), 'Index'),
			DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Kapanış Tutarı'),
			CONTINUE);
            
# Değişim ayından sonraki aylar için.
['Hesaplanan Kira'] =
	N: IF ( ATTRN('Period', !Period, 'Index') >=
			ATTRN('Period', DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Değişim ayı'), 'Index'),
			IF (DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Sabit/Oran') @= 'Oran',
				DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Kapanış Tutarı') *
			   (DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Oran %') + 1 ),
				DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Kapanış Tutarı') +
			    DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Artış Tutarı (Sabit için)')),
              CONTINUE);

# Yabancı para birimleri için.
['Hesaplanan Kira (Toplam TRY)'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'USD',
			['Hesaplanan Kira'] * DB( 'V_P', !Version, !Period, 'Aysonu Kur - USD'  ),
		    CONTINUE);

['Hesaplanan Kira (Toplam TRY)'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'EUR',
			['Hesaplanan Kira'] * DB( 'V_P', !Version, !Period, 'Aysonu Kur - EUR'  ),
		    CONTINUE);

['Hesaplanan Kira (Toplam TRY)'] =
	N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'GBP',
			['Hesaplanan Kira'] * DB( 'V_P', !Version, !Period, 'Aysonu Kur - GBP'  ),
		    CONTINUE);

# Para birimi seçimi yapılmamış ise TL gibi hesaplanacak.
['Hesaplanan Kira (Toplam TRY)'] = N: ['Hesaplanan Kira'];

['Hesaplanan Kira (TRY)'] = N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'TL' %
                                    DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= '', ['Hesaplanan Kira'], 0);

['Hesaplanan Kira (USD)'] = N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'USD', ['Hesaplanan Kira'], 0);

['Hesaplanan Kira (EUR)'] = N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'EUR', ['Hesaplanan Kira'], 0);

['Hesaplanan Kira (GBP)'] = N: IF ( DB('Kira - Gider', !Kira_Gider_Türleri, !Masraf_Kar_Merkezleri, !Version, 'Opening '|ATTRS( 'Period', !Period, 'Year' ), 'Para Birimi') @= 'GBP', ['Hesaplanan Kira'], 0);


FEEDERS;

['Aktif', 'Kapanış Tutarı'] => ['Hesaplanan Kira'], ['Hesaplanan Kira (Toplam TRY)'], ['Hesaplanan Kira (TRY)'], ['Hesaplanan Kira (USD)'], ['Hesaplanan Kira (EUR)'], ['Hesaplanan Kira (GBP)'];

['Aktif', 'Kira Ciro %'] => ['Kira Türü'];

['Aktif', 'Opening 2025'] => ['2025-01'];
['Aktif', 'Opening 2025'] => ['2025-02'];
['Aktif', 'Opening 2025'] => ['2025-03'];
['Aktif', 'Opening 2025'] => ['2025-04'];
['Aktif', 'Opening 2025'] => ['2025-05'];
['Aktif', 'Opening 2025'] => ['2025-06'];
['Aktif', 'Opening 2025'] => ['2025-07'];
['Aktif', 'Opening 2025'] => ['2025-08'];
['Aktif', 'Opening 2025'] => ['2025-09'];
['Aktif', 'Opening 2025'] => ['2025-10'];
['Aktif', 'Opening 2025'] => ['2025-11'];
['Aktif', 'Opening 2025'] => ['2025-12'];
['Aktif', 'Opening 2026'] => ['2026-01'];
['Aktif', 'Opening 2026'] => ['2026-02'];
['Aktif', 'Opening 2026'] => ['2026-03'];
['Aktif', 'Opening 2026'] => ['2026-04'];
['Aktif', 'Opening 2026'] => ['2026-05'];
['Aktif', 'Opening 2026'] => ['2026-06'];
['Aktif', 'Opening 2026'] => ['2026-07'];
['Aktif', 'Opening 2026'] => ['2026-08'];
['Aktif', 'Opening 2026'] => ['2026-09'];
['Aktif', 'Opening 2026'] => ['2026-10'];
['Aktif', 'Opening 2026'] => ['2026-11'];
['Aktif', 'Opening 2026'] => ['2026-12'];
['Aktif', 'Opening 2027'] => ['2027-01'];
['Aktif', 'Opening 2027'] => ['2027-02'];
['Aktif', 'Opening 2027'] => ['2027-03'];
['Aktif', 'Opening 2027'] => ['2027-04'];
['Aktif', 'Opening 2027'] => ['2027-05'];
['Aktif', 'Opening 2027'] => ['2027-06'];
['Aktif', 'Opening 2027'] => ['2027-07'];
['Aktif', 'Opening 2027'] => ['2027-08'];
['Aktif', 'Opening 2027'] => ['2027-09'];
['Aktif', 'Opening 2027'] => ['2027-10'];
['Aktif', 'Opening 2027'] => ['2027-11'];
['Aktif', 'Opening 2027'] => ['2027-12'];

['Aktif', 'Toplam Kira Gideri', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Kira', !Masraf_Kar_Merkezleri, !Version, !Period, 'Hesaplanan Kira Gideri'  );
['Aktif', {'Mağaza Kirası', 'Depo Kirası'}, 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Kira', !Masraf_Kar_Merkezleri, !Version, !Period, 'Mağaza + Depo Kira Gideri'  );
['Aktif', {'Mağaza Kirası', 'Ortak Gider'}, 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Kira', !Masraf_Kar_Merkezleri, !Version, !Period, 'Mağaza + Ortak Gider Kira Gideri'  );
  
['Aktif', 'Mağaza Kirası', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200002', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Depo Kirası', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200005', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Ek Depo Kirası', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200005', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Ortak Gider', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200004', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Totem Kira', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200006', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Otopark Kirası', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200006', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Otopark Kirası 2', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200006', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Ek Yer Kirası', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200006', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Diğer Gider', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200006', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
['Aktif', 'Darty Ciro Kirası', 'Hesaplanan Kira (Toplam TRY)'] => DB( 'Genel Giderler', '8100200003', !Masraf_Kar_Merkezleri, 'Mali İşler - Genel', !Version, !Period, 'Hesaplanan Tutar' );
